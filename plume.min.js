!function(){"use strict";function e(e){w=e&&e.state&&e.state.roomName,w?(e=e||!0,v.roomName.value=w):"change"===e.type?w=v.roomName.value:(w=y.toString(),v.roomName.placeholder=w+" (random)",v.roomName.value=""),e&&"popstate"!==e.type&&history.pushState({roomName:w},"Room ID: "+w,"?room="+w)}function o(e){E=e&&e.state&&e.state.userName,E?v.userName.value=E:"change"===e.type?E=v.userName.value:(E=y.toString(),v.userName.placeholder=E+" (random)",v.userName.value="")}function n(){return v.roomName.value||w}function t(){return v.userName.value||E}function r(e,o){var n=e.match(o);return n&&n[1]}function a(e){v.loginForm.style.display="none",v.frontBuffer.focus()}function i(){v.loginForm.style.display="",v.userName.focus()}function s(e){v.errorMessage.innerHTML=e,v.errorMessage.style.display="block",i(),c(!1)}function c(e){f.forEach(function(o){return o.disabled=e}),document.body.style.cursor=e?"wait":""}function l(){v.loginForm.style.display="",window.addEventListener("vrdisplaypresentchange",function(){var e=M.input.VR.currentDevice;v.controls.style.display=e&&e.isPresenting?"none":""}),M.displays.forEach(function(e,o){var n=document.createElement("button"),t=(Primrose.Input.VR.isStereoDisplay(e),M.goFullScreen.bind(M,o));n.type="button",n.className="primary",n.innerHTML=e.displayName,n.addEventListener("click",t),window.addEventListener("vrdisplayactivate",function(e,o,n){if(n.display===e){var t=function e(){window.removeEventListener("vrdisplaydeactivate",e),M.input.VR.cancel()};window.addEventListener("vrdisplaydeactivate",t,!1),o()}}.bind(window,e,t),!1),v.fullScreenButtonContainer.appendChild(n)}),M.scene.traverse(function(e){0===e.name.indexOf("LightPanel")&&e.material.emissive.setRGB(1,1,1)})}function u(e){e&&"keyup"===e.type&&e.keyCode!==Primrose.Keys.ENTER||(c(!0),k||(console.log("connecting to: %s",h),k=io(h),k.on("connect_error",d),k.on("reconnect",u),k.on("loginFailed",m),k.on("loginComplete",p),k.on("errorDetail",console.error.bind(console))),k.emit("guest",{userName:t(),appKey:n()}))}function d(e){k.close(),k=null,M.disconnect(),m("an error occured while connecting to the server.")}function m(e){s("We couldn't log you in right now because "+e.replace(/\[USER\]/g,v.userName.value))}function p(){v.errorMessage.innerHTML="",v.errorMessage.style.display="none",c(!1),a();var e=t(),o=n();document.cookie="user="+e+"&room="+o,M.connect(k,e),document.title=e+" in "+o,Primrose.HTTP.getObject("/tokbox/?room="+o+"&user="+e).then(function(e){console.log("tokbox",e),L=OT.initSession(e.apiKey,e.sessionId).on("streamCreated",function(e){var o=e.stream.connection.data.match(N);console.log("tokbox streamCreated",e,o&&o[1]),L.subscribe(e.stream)}).connect(e.token,function(e){if(e)console.error("tokbox error",e);else{var o=OT.initPublisher();o.publishVideo(!1),console.log("tokbox publisher",o),L.publish(o)}}),console.log("tokbox session",L)})}WebVRStandardMonitor();var v=Primrose.DOM.findEverything(),f=[v.userName,v.connect],y=NameGen.compile("!mi"),g=location.protocol.replace("http","ws"),h=g+"//"+location.hostname,b=/\broom=(\w+)/,N=/\buser=(\w+)/,w=null,E=null,k=null,L=null,M=new Primrose.BrowserEnvironment({useFog:!1,autoScaleQuality:!0,autoRescaleQuality:!1,quality:Quality.HIGH,groundTexture:0,backgroundColor:0,disableDefaultLighting:!0,sceneModel:"models/meeting/meetingroom.obj",avatarModel:"models/avatar.json",font:"fonts/helvetiker_regular.typeface.json",disableWebRTC:!0});v.closeButton.addEventListener("click",a,!1),v.userName.addEventListener("keyup",u,!1),v.connect.addEventListener("click",u,!1),v.randomRoomName.addEventListener("click",e,!1),v.randomUserName.addEventListener("click",o,!1),v.roomName.addEventListener("change",e,!1),v.userName.addEventListener("change",o,!1),window.addEventListener("popstate",e),M.addEventListener("ready",l),e({state:{roomName:r(location.search,b)||r(document.cookie,b)}}),o({state:{userName:r(location.search,N)||r(document.cookie,N)}}),"undefined"!=typeof window&&(window.app=M)}(),console.info("plume v0.0.2. see https://www.plumevr.com for more information.");