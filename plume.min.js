!function(){"use strict";function e(e){w=e&&e.state&&e.state.roomName,w?(e=e||!0,v.roomName.value=w):"change"===e.type?w=v.roomName.value:(w=f.toString(),v.roomName.placeholder=w+" (random)",v.roomName.value=""),e&&"popstate"!==e.type&&history.pushState({roomName:w},"Room ID: "+w,"?room="+w)}function o(e){E=e&&e.state&&e.state.userName,E?v.userName.value=E:"change"===e.type?E=v.userName.value:(E=f.toString(),v.userName.placeholder=E+" (random)",v.userName.value="")}function n(){return v.roomName.value||w}function t(){return v.userName.value||E}function r(e,o){var n=e.match(o);return n&&n[1]}function i(e){v.loginForm.style.display="none",v.frontBuffer.focus()}function a(){v.loginForm.style.display="",v.userName.focus()}function s(e){v.errorMessage.innerHTML=e,v.errorMessage.style.display="block",a(),c(!1)}function c(e){y.forEach(function(o){return o.disabled=e}),document.body.style.cursor=e?"wait":""}function l(){v.loginForm.style.display="",window.addEventListener("vrdisplaypresentchange",function(){var e=M.input.VR.currentDevice;v.controls.style.display=e&&e.isPresenting?"none":""}),M.displays.forEach(function(e,o){var n=document.createElement("button"),t=(Primrose.Input.VR.isStereoDisplay(e),M.goFullScreen.bind(M,o));n.type="button",n.className="primary",n.innerHTML=e.displayName,n.addEventListener("click",t),window.addEventListener("vrdisplayactivate",function(e,o,n){if(n.display===e){var t=function e(){window.removeEventListener("vrdisplaydeactivate",e),M.input.VR.cancel()};window.addEventListener("vrdisplaydeactivate",t,!1),o()}}.bind(window,e,t),!1),v.fullScreenButtonContainer.appendChild(n)}),M.scene.traverse(function(e){0===e.name.indexOf("LightPanel")&&e.material.emissive.setRGB(1,1,1)})}function u(e){e&&"keyup"===e.type&&e.keyCode!==Primrose.Keys.ENTER||(c(!0),k||(console.log("connecting to: %s",b),k=io(b),k.on("connect_error",d),k.on("reconnect",u),k.on("loginFailed",m),k.on("loginComplete",p),k.on("errorDetail",console.error.bind(console))),k.emit("guest",{userName:t(),appKey:n()}))}function d(e){k.close(),k=null,M.disconnect(),m("an error occured while connecting to the server.")}function m(e){s("We couldn't log you in right now because "+e.replace(/\[USER\]/g,v.userName.value))}function p(){v.errorMessage.innerHTML="",v.errorMessage.style.display="none",c(!1),i();var e=t(),o=n();document.cookie="room="+encodeURI(o)+"&user="+encodeURI(e),M.connect(k,e),document.title=e+" in "+o,Primrose.HTTP.getObject("/tokbox/?room="+encodeURI(o)+"&user="+encodeURI(e)).then(function(o){L=OT.initSession(o.apiKey,o.sessionId),L.on("streamCreated",function(e){var o=e.stream.connection.data;L.subscribe(e.stream,"tokbox",{subscribeToAudio:!0,subscribeToVideo:!1,insertMode:"append"},function(e,n){if(e)console.error("tokbox stream error",error);else{var t=n.element.querySelector("video");console.log(o,t),M.setAudioFromUser(o,t)}})}),L.connect(o.token,function(o){o?console.error("tokbox connect error",o):(R=OT.initPublisher("tokbox",{publishAudio:!0,publishVideo:!1,videoSource:null,name:e,style:{nameDisplay:"off",buttonDisplayMode:"off",showControls:!1}}),L.publish(R))})})}WebVRStandardMonitor();var v=Primrose.DOM.findEverything(),y=[v.userName,v.connect],f=NameGen.compile("!mi"),g=location.protocol.replace("http","ws"),b=g+"//"+location.hostname,h=/\broom=(\w+)/,N=/\buser=(\w+)/,w=null,E=null,k=null,L=null,R=null,M=new Primrose.BrowserEnvironment({useFog:!1,autoScaleQuality:!0,autoRescaleQuality:!1,quality:Quality.HIGH,groundTexture:0,backgroundColor:0,disableDefaultLighting:!0,sceneModel:"models/meeting/meetingroom.obj",avatarModel:"models/avatar.json",font:"fonts/helvetiker_regular.typeface.json",disableWebRTC:!0});v.closeButton.addEventListener("click",i,!1),v.userName.addEventListener("keyup",u,!1),v.connect.addEventListener("click",u,!1),v.randomRoomName.addEventListener("click",e,!1),v.randomUserName.addEventListener("click",o,!1),v.roomName.addEventListener("change",e,!1),v.userName.addEventListener("change",o,!1),window.addEventListener("popstate",e),M.addEventListener("ready",l),e({state:{roomName:r(location.search,h)||r(document.cookie,h)}}),o({state:{userName:r(location.search,N)||r(document.cookie,N)}}),"undefined"!=typeof window&&(window.app=M)}();