!function(){function e(e){k=e&&e.state&&e.state.roomName,k?(e=e||!0,y.roomName.value=k):"change"===e.type?k=y.roomName.value:(k=g.toString(),y.roomName.placeholder="Type a room name (currently "+k+")",y.roomName.value=""),e&&"popstate"!==e.type&&history.pushState({roomName:k},"Room ID: "+k,"?room="+k)}function o(e){E=e&&e.state&&e.state.userName,E?y.userName.value=E:"change"===e.type?E=y.userName.value:(E=g.toString(),y.userName.placeholder="Type a user name (currently "+E+")",y.userName.value="")}function n(){return y.roomName.value||k}function t(){return y.userName.value||E}function r(e,o){var n=e.match(o);return n&&n[1]}function a(e){y.loginForm.style.display="none",y.frontBuffer.focus()}function s(){y.loginForm.style.display="",y.userName.focus()}function i(e){y.errorMessage.innerHTML=e,y.errorMessage.style.display="block",s(),c(!1)}function c(e){f.forEach(function(o){return o.disabled=e}),document.body.style.cursor=e?"wait":""}function l(){y.loginForm.style.display="",y.prog.style.display="none",WebVRStandardMonitor(),T.input.VR.displays.forEach(function(e,o){var n=document.createElement("button");n.type="button",n.className="secondary",n.appendChild(document.createTextNode(e.displayName)),n.addEventListener("click",T.goFullScreen.bind(T,o,"Button")),y.controls.appendChild(n)}),T.scene.traverse(function(e){0===e.name.indexOf("LightPanel")&&e.material.emissive.setRGB(1,1,1)})}function u(e){e&&"keyup"===e.type&&e.keyCode!==Primrose.Keys.ENTER||(c(!0),w||(console.log("connecting to: %s",h),w=io(h),w.on("connect_error",m),w.on("reconnect",u),w.on("loginFailed",d),w.on("loginComplete",p),w.on("errorDetail",console.error.bind(console))),w.emit("guest",{userName:t(),appKey:n()}))}function m(e){w.close(),w=null,T.disconnect(),d("an error occured while connecting to the server.")}function d(e){i("We couldn't log you in right now because "+e.replace(/\[USER\]/g,y.userName.value))}function p(){y.errorMessage.innerHTML="",y.errorMessage.style.display="none",c(!1),a();var e=t(),o=n();document.cookie="user="+e+"&room="+o,T.connect(w,e),document.title=e+" in "+o,Primrose.HTTP.getObject("/tokbox/?room="+o+"&user="+e).then(function(e){console.log("tokbox",e),L=OT.initSession(e.apiKey,e.sessionId).on("streamCreated",function(e){var o=e.stream.connection.data.match(N);console.log("tokbox streamCreated",e,o&&o[1]),L.subscribe(e.stream)}).connect(e.token,function(e){if(e)console.error("tokbox error",e);else{var o=OT.initPublisher();o.publishVideo(!1),console.log("tokbox publisher",o),L.publish(o)}}),console.log("tokbox session",L)})}WebVRStandardMonitor();var y=Primrose.DOM.findEverything(),f=[y.userName,y.connect],g=NameGen.compile("!mi"),v=location.protocol.replace("http","ws"),h=v+"//"+location.hostname,b=/\broom=(\w+)/,N=/\buser=(\w+)/,k=null,E=null,w=null,L=null,T=new Primrose.BrowserEnvironment({useFog:!1,autoScaleQuality:!0,autoRescaleQuality:!1,quality:Quality.HIGH,groundTexture:0,backgroundColor:0,disableDefaultLighting:!0,sceneModel:"models/meeting/meetingroom.obj",avatarModel:"models/avatar.json",font:"fonts/helvetiker_regular.typeface.json",disableWebRTC:!0});y.closeButton.addEventListener("click",a,!1),y.userName.addEventListener("keyup",u,!1),y.connect.addEventListener("click",u,!1),y.randomRoomName.addEventListener("click",e,!1),y.randomUserName.addEventListener("click",o,!1),y.roomName.addEventListener("change",e,!1),y.userName.addEventListener("change",o,!1),window.addEventListener("popstate",e),T.addEventListener("ready",l),e({state:{roomName:r(location.search,b)||r(document.cookie,b)}}),o({state:{userName:r(location.search,N)||r(document.cookie,N)}}),"undefined"!=typeof window&&(window.app=T)}(),console.info("plume v0.0.1. see https://www.plumevr.com for more information.");