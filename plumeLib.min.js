!function(){"use strict";function e(e){k=e&&e.state&&e.state.roomName,k?(e=e||!0,y.roomName.value=k):"change"===e.type?k=y.roomName.value:(k=g.toString(),y.roomName.placeholder=k+" (random)",y.roomName.value=""),e&&"popstate"!==e.type&&history.pushState({roomName:k},"Room ID: "+k,"?room="+k)}function o(e){E=e&&e.state&&e.state.userName,E?y.userName.value=E:"change"===e.type?E=y.userName.value:(E=g.toString(),y.userName.placeholder=E+" (random)",y.userName.value="")}function n(){return y.roomName.value||k}function t(){return y.userName.value||E}function r(e,o){var n=e.match(o);return n&&n[1]}function a(e){y.loginForm.style.display="none",y.frontBuffer.focus()}function i(){y.loginForm.style.display="",y.userName.focus()}function s(e){y.errorMessage.innerHTML=e,y.errorMessage.style.display="block",i(),c(!1)}function c(e){f.forEach(function(o){return o.disabled=e}),document.body.style.cursor=e?"wait":""}function l(){prog.bar.style.display="none",y.loginForm.style.display="",window.addEventListener("vrdisplaypresentchange",function(){var e=M.input.VR.currentDevice;y.controls.style.display=e&&e.isPresenting?"none":""}),M.displays.forEach(function(e,o){var n=document.createElement("button"),t=(Primrose.Input.VR.isStereoDisplay(e),M.goFullScreen.bind(M,o));n.type="button",n.appendChild(document.createTextNode(e.displayName)),n.addEventListener("click",t,!1),y.fullScreenButtonContainer.appendChild(n)}),M.scene.traverse(function(e){0===e.name.indexOf("LightPanel")&&e.material.emissive.setRGB(1,1,1)})}function u(e){e&&"keyup"===e.type&&e.keyCode!==Primrose.Keys.ENTER||(c(!0),w||(console.log("connecting to: %s",b),w=io(b),w.on("connect_error",d),w.on("reconnect",u),w.on("loginFailed",m),w.on("loginComplete",p),w.on("errorDetail",console.error.bind(console))),w.emit("guest",{userName:t(),appKey:n()}))}function d(e){w.close(),w=null,M.disconnect(),m("an error occured while connecting to the server.")}function m(e){s("We couldn't log you in right now because "+e.replace(/\[USER\]/g,y.userName.value))}function p(){y.errorMessage.innerHTML="",y.errorMessage.style.display="none",c(!1),a();var e=t(),o=n();document.cookie="room="+encodeURI(o)+"&user="+encodeURI(e),M.connect(w,e),document.title=e+" in "+o,Primrose.HTTP.getObject("/tokbox/?room="+encodeURI(o)+"&user="+encodeURI(e)).then(function(o){L=OT.initSession(o.apiKey,o.sessionId),console.log("session",L),L.on("streamCreated",function(e){var o=e.stream.connection.data;L.subscribe(e.stream,"tokbox",{subscribeToAudio:!0,subscribeToVideo:!1,insertMode:"append"},function(e,n){if(e)console.error("tokbox stream error",error);else{var t=n.element.querySelector("video");console.log(o,t),M.setAudioFromUser(o,t)}})}),L.connect(o.token,function(o){o?console.error("tokbox connect error",o):(R=OT.initPublisher("tokbox",{publishAudio:!0,publishVideo:!1,videoSource:null,name:e,style:{nameDisplay:"off",buttonDisplayMode:"off",showControls:!1}}),L.publish(R))})})}WebVRStandardMonitor(),prog.bar.style.height="10px";var y=Primrose.DOM.findEverything(),f=[y.userName,y.connect],g=NameGen.compile("!mi"),v=location.protocol.replace("http","ws"),b=v+"//"+location.hostname,h=/\broom=(\w+)/,N=/\buser=(\w+)/,k=null,E=null,w=null,L=null,R=null,M=new Primrose.BrowserEnvironment({useFog:!1,useGaze:!0,autoScaleQuality:!0,autoRescaleQuality:!1,quality:Quality.HIGH,groundTexture:0,backgroundColor:0,disableDefaultLighting:!0,sceneModel:"models/meeting/meetingroom.obj",avatarModel:"models/avatar.json",font:"fonts/helvetiker_regular.typeface.json",disableWebRTC:!0,progress:prog.thunk});y.closeButton.addEventListener("click",a,!1),y.userName.addEventListener("keyup",u,!1),y.connect.addEventListener("click",u,!1),y.randomRoomName.addEventListener("click",e,!1),y.randomUserName.addEventListener("click",o,!1),y.roomName.addEventListener("change",e,!1),y.userName.addEventListener("change",o,!1),window.addEventListener("popstate",e),M.addEventListener("ready",l),e({state:{roomName:r(location.search,h)||r(document.cookie,h)}}),o({state:{userName:r(location.search,N)||r(document.cookie,N)}}),"undefined"!=typeof window&&(window.app=M)}();